{% liquid
  assign ss = section.settings
  
  # Calculate dynamic values for fat zone message
  assign weight_loss_percentage = ss.weight_loss_percentage | default: 9
  assign weight_loss_amount = ss.default_weight | times: weight_loss_percentage | divided_by: 100 | round
  assign current_weight = ss.default_weight | default: 220
  assign current_height_inches = ss.default_height | default: 68
  assign current_height_feet = current_height_inches | divided_by: 12
  assign current_height_remaining_inches = current_height_inches | modulo: 12
  assign current_height_formatted = current_height_feet | append: 'ft ' | append: current_height_remaining_inches | append: 'in'
  
  # Replace dynamic values in fat zone message
  assign fat_zone_message = ss.fat_zone_message | default: "Based on clinical trials, you could lose up to [weightloss-perc]% of your body weight in 3 months you could lose up to <strong>[weightloss-amount]lbs in 3 months*</strong>"
  assign fat_zone_message = fat_zone_message | replace: '[weightloss-perc]', weight_loss_percentage
  assign fat_zone_message = fat_zone_message | replace: '[weightloss-amount]', weight_loss_amount
  assign fat_zone_message = fat_zone_message | replace: '[current-weight]', current_weight
  assign fat_zone_message = fat_zone_message | replace: '[current-height]', current_height_formatted
%}
{{ 'weightloss.css' | asset_url | stylesheet_tag }}

<section class="weightloss" style="background-color: {{ ss.bg_color }};">
  <container class="weightloss__wrapper scroll-trigger animate--slide-in">
    {% render 'heading' heading: true, h1: ss.heading_h1, title: ss.heading_title, align: ss.heading_align, align_mb: ss.heading_align_mb, sub_text: ss.heading_sub_text, text: ss.heading_text,
    ratings: ss.heading_ratings, ratings_stars: ss.heading_ratings_stars, ratings_logo: ss.heading_ratings_logo, ratings_text: ss.heading_ratings_text,  shop_all: ss.heading_shop_all %}

    <flex-col class="weightloss__content-wrapper">
      <div class="weightloss__sliders">
        <div class="weightloss__slider-group">
          <flex class="weightloss__slider-header">
            <label class="weightloss__label">{{ ss.weight_label | default: "What's your current weight?" }}</label>
            <span class="weightloss__value" id="weight-display">{{ ss.default_weight }} lbs</span>
          </flex>
          <div class="weightloss__slider-container">
            <input type="range" id="weight-slider" class="weightloss__slider" min="100" max="300" value="{{ ss.default_weight }}" step="1" style="--current-fill: 32.5%;">
          </div>
        </div>

        <div class="weightloss__slider-group">
          <flex class="weightloss__slider-header">
            <label class="weightloss__label">{{ ss.height_label | default: 'How tall are you?' }}</label>
            <span class="weightloss__value" id="height-display">5ft 8in</span>
          </flex>
          <div class="weightloss__slider-container">
            <input type="range" id="height-slider" class="weightloss__slider" min="48" max="84" value="{{ ss.default_height }}" step="1" style="--current-fill: 55.5%;">
          </div>
        </div>
      </div>

      <div class="weightloss__journey-section">
        <div class="weightloss__journey-content">
          <h3 class="weightloss__chart-title">{{ ss.chart_title | default: 'Your Weight Loss Journey' }}</h3>
          
          <div class="weightloss__journey-details">
            <div class="weightloss__journey-dates">
              <div class="weightloss__journey-start">
                <div class="weightloss__journey-date" id="start-date">{{ 'now' | date: '%b %Y' }}</div>
                <div class="weightloss__journey-weight" id="start-weight">{{ ss.default_weight }} lbs</div>
              </div>
              <div class="weightloss__journey-arrow">â†’</div>
              <div class="weightloss__journey-end">
                <div class="weightloss__journey-date" id="end-date">{{ 'now' | date: '%s' | plus: 7776000 | date: '%b %Y' }}</div>
                <div class="weightloss__journey-weight" id="end-weight">{{ 100 | minus: ss.weight_loss_percentage | times: ss.default_weight | divided_by: 100 | round }} lbs</div>
              </div>
            </div>


            
            {% comment %} <div class="weightloss__journey-description">
              <p>Track your transformation over 12 weeks with our clinically-backed approach. See how consistent progress leads to sustainable results.</p>
              <ul class="weightloss__journey-benefits">
                <li>Weekly progress tracking</li>
                <li>Sustainable weight loss</li>
                <li>Clinical support</li>
                <li>Long-term results</li>
              </ul>
            </div> {% endcomment %}
          </div>
        </div>

        <div class="weightloss__chart">
          {% render 'responsive-image', image: ss.chart_image, image_width: 640, class: 'weightloss__chart-image' %}
          
          <div class="weightloss__chart-badge weightloss__chart-badge--red" id="current-weight-badge">{{ ss.default_weight }} lbs</div>
          <div class="weightloss__chart-badge weightloss__chart-badge--green" id="target-weight-badge">{{ 100 | minus: ss.weight_loss_percentage | times: ss.default_weight | divided_by: 100 | round }} lbs</div>
        </div>
      </div>

      <div class="weightloss__fat-zone">
        <div class="weightloss__fat-zone-header">
          <div class="weightloss__fat-zone-icon"></div>
          <span class="weightloss__fat-zone-title">{{ ss.fat_zone_title | default: 'FAT LOSS ZONE' }}</span>
        </div>
        <div class="weightloss__fat-zone-content">
          <p class="weightloss__fat-zone-text" id="bmi-message">
            {{ fat_zone_message }}
          </p>
        </div>
      </div>
    </flex-col>

  </container>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const weightSlider = document.getElementById('weight-slider');
  const heightSlider = document.getElementById('height-slider');
  const weightDisplay = document.getElementById('weight-display');
  const heightDisplay = document.getElementById('height-display');
  const currentWeightBadge = document.getElementById('current-weight-badge');
  const targetWeightBadge = document.getElementById('target-weight-badge');
  const bmiMessage = document.getElementById('bmi-message');
  const startDate = document.getElementById('start-date');
  const endDate = document.getElementById('end-date');
  const startWeight = document.getElementById('start-weight');
  const endWeight = document.getElementById('end-weight');

  function formatHeight(inches) {
    const feet = Math.floor(inches / 12);
    const remainingInches = inches % 12;
    return feet + 'ft ' + remainingInches + 'in';
  }

  function calculateBMI(weightLbs, heightInches) {
    const weightKg = weightLbs * 0.453592;
    const heightM = heightInches * 0.0254;
    return weightKg / (heightM * heightM);
  }

  function formatDate(date) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return months[date.getMonth()] + ' ' + date.getFullYear();
  }


  function updateDisplay() {
    if (!weightSlider || !heightSlider) return;
    
    const weight = parseInt(weightSlider.value);
    const height = parseInt(heightSlider.value);
    const bmi = calculateBMI(weight, height);
    const weightLossPercentage = {{ ss.weight_loss_percentage | default: 9 }} / 100;
    const weightLoss = Math.round(weight * weightLossPercentage * 100) / 100;
    const targetWeight = weight - Math.round(weight * weightLossPercentage);

    const currentDate = new Date();
    const futureDate = new Date();
    futureDate.setMonth(currentDate.getMonth() + 3);

    // Update slider fill values
    const weightFill = ((weight - 100) / (300 - 100)) * 100;
    const heightFill = ((height - 48) / (84 - 48)) * 100;
    
    weightSlider.style.setProperty('--current-fill', weightFill + '%');
    heightSlider.style.setProperty('--current-fill', heightFill + '%');

    if (weightDisplay) weightDisplay.textContent = weight + ' lbs';
    if (heightDisplay) heightDisplay.textContent = formatHeight(height);
    if (currentWeightBadge) currentWeightBadge.textContent = weight + ' lbs';
    
    if (startDate) startDate.textContent = formatDate(currentDate);
    if (endDate) endDate.textContent = formatDate(futureDate);
    if (startWeight) startWeight.textContent = weight + ' lbs';
    
    if (bmi >= 26) {
      if (targetWeightBadge) targetWeightBadge.textContent = targetWeight + ' lbs';
      if (endWeight) endWeight.textContent = targetWeight + ' lbs';
      
      // Update fat zone message with dynamic values
      let dynamicMessage = '{{ ss.fat_zone_message | default: "Based on clinical trials, you could lose up to [weightloss-perc]% of your body weight in 3 months you could lose up to <strong>[weightloss-amount]lbs in 3 months*</strong>" }}';
      dynamicMessage = dynamicMessage.replace('[weightloss-perc]', weightLossPercentage * 100);
      dynamicMessage = dynamicMessage.replace('[weightloss-amount]', weightLoss);
      dynamicMessage = dynamicMessage.replace('[current-weight]', weight);
      dynamicMessage = dynamicMessage.replace('[current-height]', formatHeight(height));
      if (bmiMessage) bmiMessage.innerHTML = dynamicMessage;
    } else if (bmi >= 18) {
      if (targetWeightBadge) targetWeightBadge.textContent = weight + ' lbs';
      if (endWeight) endWeight.textContent = weight + ' lbs';
      if (bmiMessage) bmiMessage.textContent = "{{ ss.healthy_bmi_message }}";
    } else {
      if (targetWeightBadge) targetWeightBadge.textContent = weight + ' lbs';
      if (endWeight) endWeight.textContent = weight + ' lbs';
      if (bmiMessage) bmiMessage.textContent = '{{ ss.low_bmi_message }}';
    }
  }

  if (weightSlider) weightSlider.addEventListener('input', updateDisplay);
  if (heightSlider) heightSlider.addEventListener('input', updateDisplay);
  
  updateDisplay();
});
</script>

{% schema %}
{
  "name": "Weight Loss Calculator",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#F6F6F6"
    }, {
      "type": "header",
      "content": "Heading"
    }, {
      "type": "checkbox",
      "id": "heading_h1",
      "label": "Heading H1"
    }, {
      "type": "text",
      "id": "heading_title",
      "label": "Heading Title",
      "default": "Your Transformation Starts Here"
    }, {
      "type": "text",
      "id": "heading_sub_text",
      "label": "Heading Sub-Text"
    }, {
      "type": "text",
      "id": "heading_text",
      "label": "Heading Text",
      "default": "Slide your weight and find out how much weight you could lose over 3 months."
    }, {
      "type": "select",
      "id": "heading_align",
      "label": "Heading Alignment",
      "default": "center",
      "options": [
        { "value": "start", "label": "Start" }, 
        { "value": "center", "label": "Center" },
        { "value": "end", "label": "End" }
      ]
    }, {
      "type": "select",
      "id": "heading_align_mb",
      "label": "Heading Alignment Mobile",
      "default": "center-mb",
      "options": [
        { "value": "start-mb", "label": "Start" }, 
        { "value": "center-mb", "label": "Center" },
        { "value": "end-mb", "label": "End" }
      ]
    }, {
      "type": "collection",
      "id": "heading_shop_all",
      "label": "Shop All"
    }, {
      "type": "header",
      "content": "Ratings"
    }, {
      "type": "checkbox",
      "id": "heading_ratings",
      "label": "Display Ratings"
    }, {
      "type": "image_picker",
      "id": "heading_ratings_stars",
      "label": "Ratings Stars",
      "visible_if": "{{ section.settings.heading_ratings }}"
    }, {
      "type": "image_picker",
      "id": "heading_ratings_logo",
      "label": "Ratings Logo",
      "visible_if": "{{ section.settings.heading_ratings }}"
    }, {
      "type": "text",
      "id": "heading_ratings_text",
      "label": "Ratings Text",
      "visible_if": "{{ section.settings.heading_ratings }}"
    }, {
      "type": "header",
      "content": "Content"
    }, {
      "type": "text",
      "id": "weight_label",
      "label": "Weight Label",
      "default": "What's your current weight?"
    }, {
      "type": "text",
      "id": "height_label",
      "label": "Height Label",
      "default": "How tall are you?"
    }, {
      "type": "text",
      "id": "chart_title",
      "label": "Chart Title",
      "default": "Your Weight Loss Journey"
    }, {
      "type": "text",
      "id": "fat_zone_title",
      "label": "Fat Zone Title",
      "default": "FAT LOSS ZONE"
    }, {
      "type": "header",
      "content": "Chart"
    }, {
      "type": "image_picker",
      "id": "chart_image",
      "label": "Chart Image"
    }, {
      "type": "header",
      "content": "Default Values"
    }, {
      "type": "number",
      "id": "default_weight",
      "label": "Default Weight (lbs)",
      "default": 220
    }, {
      "type": "number",
      "id": "default_height",
      "label": "Default Height (inches)",
      "default": 68
    }, {
      "type": "number",
      "id": "weight_loss_percentage",
      "label": "Weight Loss Percentage",
      "default": 9,
      "info": "Percentage of body weight that can be lost in 3 months"
    }, {
      "type": "header",
      "content": "Fat Zone Content"
    }, {
      "type": "textarea",
      "id": "fat_zone_message",
      "label": "Fat Zone Message",
      "default": "Based on clinical trials, you could lose up to [weightloss-perc]% of your body weight in 3 months you could lose up to <strong>[weightloss-amount]lbs in 3 months*</strong>",
      "info": "Wrap in [square-brackets] to display dynamic values. Use [weightloss-perc] for weight loss percentage, [weightloss-amount] for weight loss amount, [current-weight] for current weight, [current-height] for current height. Use HTML tags like <strong> for styling."
    }, {
      "type": "textarea",
      "id": "healthy_bmi_message",
      "label": "Healthy BMI Message",
      "default": "You're already in a healthy BMI range. Nordburn can support appetite regulation, gut health, and long-term weight maintenance"
    }, {
      "type": "textarea",
      "id": "low_bmi_message",
      "label": "Low BMI Message",
      "default": "Nordburn is designed to support those with weight loss goals. we recommend consulting a healthcare professional before use"
    }
  ],
  "presets": [
    {
      "name": "Weight Loss Calculator"
    }
  ]
}
{% endschema %}
